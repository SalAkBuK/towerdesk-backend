generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String   @id @default(uuid())
  email            String   @unique
  passwordHash     String
  refreshTokenHash String?
  name             String?
  avatarUrl        String?
  phone            String?
  orgId            String?
  mustChangePassword Boolean @default(false)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  org              Org?     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userRoles        UserRole[]
  userPermissions  UserPermission[]
  buildingAssignments BuildingAssignment[]
  residentOccupancies Occupancy[]
  maintenanceRequestsCreated MaintenanceRequest[] @relation("MaintenanceRequestCreator")
  maintenanceRequestsAssigned MaintenanceRequest[] @relation("MaintenanceRequestAssignee")
  maintenanceRequestComments MaintenanceRequestComment[]
  maintenanceRequestAttachments MaintenanceRequestAttachment[]
  notifications Notification[] @relation("NotificationRecipient")

  @@index([orgId])
}

model Org {
  id        String     @id @default(uuid())
  name      String
  logoUrl   String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  users     User[]
  buildings Building[]
  maintenanceRequests MaintenanceRequest[]
  maintenanceRequestComments MaintenanceRequestComment[]
  maintenanceRequestAttachments MaintenanceRequestAttachment[]
  notifications Notification[]
}

model Building {
  id        String   @id @default(uuid())
  orgId     String
  name      String
  city      String
  emirate   String?
  country   String   @default("ARE")
  timezone  String   @default("Asia/Dubai")
  floors    Int?
  unitsCount Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  units     Unit[]
  assignments BuildingAssignment[]
  occupancies Occupancy[]
  maintenanceRequests MaintenanceRequest[]

  @@index([orgId])
}

model Unit {
  id         String   @id @default(uuid())
  buildingId String
  label      String
  floor      Int?
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  building   Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  occupancies Occupancy[]
  maintenanceRequests MaintenanceRequest[]

  @@unique([buildingId, label])
  @@index([buildingId])
}

enum BuildingAssignmentType {
  MANAGER
  STAFF
  BUILDING_ADMIN
}

model BuildingAssignment {
  id         String                 @id @default(uuid())
  buildingId String
  userId     String
  type       BuildingAssignmentType
  createdAt  DateTime               @default(now())
  updatedAt  DateTime               @updatedAt
  building   Building               @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  user       User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([buildingId, userId, type])
  @@index([buildingId])
  @@index([userId])
}

enum OccupancyStatus {
  ACTIVE
  ENDED
}

model Occupancy {
  id             String          @id @default(uuid())
  buildingId     String
  unitId         String
  residentUserId String
  status         OccupancyStatus @default(ACTIVE)
  startAt        DateTime        @default(now())
  endAt          DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  building       Building        @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  unit           Unit            @relation(fields: [unitId], references: [id], onDelete: Cascade)
  residentUser   User            @relation(fields: [residentUserId], references: [id], onDelete: Cascade)

  @@index([buildingId])
  @@index([unitId])
  @@index([residentUserId])
}

enum MaintenanceRequestStatus {
  OPEN
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELED
}

enum MaintenanceRequestPriority {
  LOW
  NORMAL
  HIGH
}

enum MaintenanceRequestType {
  CLEANING
  ELECTRICAL
  MAINTENANCE
  PLUMBING_AC_HEATING
  OTHER
}

model MaintenanceRequest {
  id               String                     @id @default(uuid())
  orgId            String
  buildingId       String
  unitId           String?
  createdByUserId  String
  title            String
  description      String?
  status           MaintenanceRequestStatus   @default(OPEN)
  type             MaintenanceRequestType?
  priority         MaintenanceRequestPriority?
  assignedToUserId String?
  assignedAt       DateTime?
  completedAt      DateTime?
  canceledAt       DateTime?
  createdAt        DateTime                   @default(now())
  updatedAt        DateTime                   @updatedAt
  org              Org                        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  building         Building                   @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  unit             Unit?                      @relation(fields: [unitId], references: [id], onDelete: SetNull)
  createdByUser    User                       @relation("MaintenanceRequestCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)
  assignedToUser   User?                      @relation("MaintenanceRequestAssignee", fields: [assignedToUserId], references: [id], onDelete: SetNull)
  comments         MaintenanceRequestComment[]
  attachments      MaintenanceRequestAttachment[]

  @@index([orgId, buildingId])
  @@index([createdByUserId])
  @@index([assignedToUserId])
  @@index([status])
}

model MaintenanceRequestComment {
  id            String   @id @default(uuid())
  requestId     String
  orgId         String
  authorUserId  String
  message       String
  createdAt     DateTime @default(now())
  request       MaintenanceRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  org           Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  authorUser    User     @relation(fields: [authorUserId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@index([authorUserId])
}

model MaintenanceRequestAttachment {
  id              String   @id @default(uuid())
  requestId       String
  orgId           String
  uploadedByUserId String
  fileName        String
  mimeType        String
  sizeBytes       Int
  url             String
  createdAt       DateTime @default(now())
  request         MaintenanceRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  org             Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  uploadedByUser  User     @relation(fields: [uploadedByUserId], references: [id], onDelete: Cascade)

  @@index([requestId])
}

enum NotificationType {
  REQUEST_CREATED
  REQUEST_ASSIGNED
  REQUEST_STATUS_CHANGED
  REQUEST_COMMENTED
  REQUEST_CANCELED
}

model Notification {
  id               String           @id @default(uuid())
  orgId            String
  recipientUserId  String
  type             NotificationType
  title            String
  body             String?
  data             Json
  readAt           DateTime?
  createdAt        DateTime         @default(now())
  org              Org              @relation(fields: [orgId], references: [id], onDelete: Cascade)
  recipientUser    User             @relation("NotificationRecipient", fields: [recipientUserId], references: [id], onDelete: Cascade)

  @@index([recipientUserId, createdAt])
  @@index([orgId, recipientUserId])
}

model Role {
  id              String           @id @default(uuid())
  key             String           @unique
  name            String
  description     String?
  isSystem        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]
  userRoles       UserRole[]
}

model Permission {
  id              String           @id @default(uuid())
  key             String           @unique
  name            String
  description     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]
  userPermissions UserPermission[]
}

model RolePermission {
  roleId       String
  permissionId String
  createdAt    DateTime   @default(now())
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model UserRole {
  userId    String
  roleId    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

enum PermissionEffect {
  ALLOW
  DENY
}

model UserPermission {
  userId       String
  permissionId String
  effect       PermissionEffect
  createdAt    DateTime   @default(now())
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([userId, permissionId])
}
